.on_always:
  rules:
    - !reference [.rules-map, on_commit_merge]
    - !reference [.rules-map, allow_failure_distros]
    - !reference [.rules-map, not_allow_failure_distros]

.on_default_tag:
  rules:
    - !reference [.rules-map, not_commit_tag]
    - !reference [.rules-map, allow_failure_distros]
    - !reference [.rules-map, not_allow_failure_distros]

.on_default_merge_event:
  rules:
    - !reference [.rules-map, not_merge_event]
    - !reference [.rules-map, allow_failure_distros]
    - !reference [.rules-map, not_allow_failure_distros]

.on_default_merge_tag:
  rules:
    - !reference [.rules-map, not_merge_into_default_devel_and_tag]
    - !reference [.rules-map, allow_failure_distros]
    - !reference [.rules-map, not_allow_failure_distros]

.on_default_merge_event_merge_tag:
  rules:
    - !reference [.rules-map, merge_event_to_default_devel_and_tag]
    - !reference [.rules-map, allow_failure_distros]
    - !reference [.rules-map, not_allow_failure_distros]

.rules-map:
  allow_failure_distros:
    - if: $ROS_DISTRO !~ $DEFAULT_ROS_DISTROS
      when: on_success
      allow_failure: true
  not_allow_failure_distros:
    - if: $ROS_DISTRO =~ $DEFAULT_ROS_DISTROS
      when: on_success
      allow_failure: false
  not_merge_into_default_devel:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      when: never
  not_merge_into_default_devel_and_tag:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH && $CI_COMMIT_TAG == null
      when: never
  commit_tag:
    - if: $CI_COMMIT_TAG != null
      when: on_success
  not_commit_tag:
    - if: $CI_COMMIT_TAG != null
      when: never
  not_merge_event:
    - if: $CI_PIPELINE_SOURCE != "merge_request_event"
      when: never
  on_commit_merge:
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
  merge_event_to_default_devel_and_tag:
    - if: $CI_PIPELINE_SOURCE != "merge_request_event" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH && $CI_COMMIT_TAG == null
      when: never
